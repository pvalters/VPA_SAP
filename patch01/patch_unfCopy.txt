/*
	This patch adds the following columns MigratedGuaranteeCode,MigrationDate,MigrationDateID,MigratedEntitys to DimGuarantee
	
	List of SQL scripts to deploy:
		DWExtract.PLT_TRADE_FINANCE
		DWClean.PLT_TRADE_FINANCE
		DWStage.Guarantee
		DWSkey.DimGuarantee
		VWKey.DimGuarantee
		DWConform.DimGuarantee
		DW.DimGuarantee
		DimGuarantee.DW.indexes
			
	List of DS objects to deploy:
		File Locations:
		
		File formats:
		FMT_PLT_TRADE_FINANCE		
	
		Tables:
		DWExtract.PLT_TRADE_FINANCE	
		DWClean.PLT_TRADE_FINANCE
		DWStage.Guarantee
		DWSkey.DimGuarantee
		VWKey.DimGuarantee
		DWConform.DimGuarantee
		DW.DimGuarantee
			
		Dataflows:
		DF_read_PLT_TRADE_FINANCE		             
		DF_clean_PLT_TRAD_FINANCE
		DF_transform_DNBLV_Guarantee
		DF_transform_NDEA_Guarantee
		DF_transform_PLT_GUARANTEE
		DF_transform_PLT_TRADE_FINANCE
		DF_conform_DimGuarantee
		DF_load_DimGuarantee
			
			
			
	List of DS objects to remove:                                                 
		
	List of SQL scripts to remove:
		
	Remove entire folder as well:
		
	Deployment on LDWH:

*/

message 'Update structure of dwread area' type info to client;

drop table if exists DWExtract.PLT_TRADE_FINANCE;
read 'C:\Users\Administrator\Desktop\patch01\DWExtract.PLT_TRADE_FINANCE.ddl';

message 'Update structure of dwclean area' type info to client;

drop table if exists DWClean.PLT_TRADE_FINANCE;
read 'C:\Users\Administrator\Desktop\patch01\DWClean.PLT_TRADE_FINANCE.ddl';

message 'Update structure of dwstage area' type info to client;

drop table if exists DWStage.Guarantee;
read 'C:\Users\Administrator\Desktop\patch01\DWStage.Guarantee.ddl';

message 'Backup DW and Skey tables ...' type info to client;

if object_id( 'DWSkey.DimGuarantee_Old' ) is null then
	alter table DWSkey.DimGuarantee rename DimGuarantee_Old;
end if;

if object_id( 'DW.DimGuarantee_Old' ) is null then
	alter table DW.DimGuarantee rename DimGuarantee_Old;
end if;

message 'Backup DW and Skey tables is completed' type info to client;

message 'Create new DWSKey structure and restore data ...' type info to client;

drop table if exists DWSkey.DimGuarantee;
read 'C:\Users\Administrator\Desktop\patch01\DWSkey.DimGuarantee.ddl';

insert into DWSKey.DimGuarantee(
  ETLProcessID             
, ETLProcessRunID          
, ETLProcessDateID         
, GuaranteeKey             
, GuaranteeID              
, StartDateID              
, EndDateID                             
, SourceSystemCode                 
, AgreementNumber          
, GuaranteeStartDate     
, GuaranteeMaturityDate  
, GuaranteeCurrency             
, ProvisionCurrency    
, ProductNumber            
, PortfolioCode   
, BeneficiaryPortfolioCode 
, GuaranteeStatus      
, GLAccount                
, IsCancellable       
, IsDefaulted
, DefaultDate      
, AccountNumber
, RiskStageCode
, RiskStageName
, ContractNumber
, AdjustedRiskStageCode
, AdjustedRiskStageName
, OpenAmount
, UncommittedFlag
, ActualExpiryDate
, OriginalSource
, LBCreditNumber
, PaidAmountDueDebtGLAccount
, MigratedGuaranteeCode
, MigrationDate
, MigrationDateID
, MigratedEntity
 )
select 
  ETLProcessID             
, ETLProcessRunID          
, ETLProcessDateID         
, GuaranteeKey             
, GuaranteeID              
, StartDateID              
, EndDateID                             
, SourceSystemCode                 
, AgreementNumber          
, GuaranteeStartDate     
, GuaranteeMaturityDate  
, GuaranteeCurrency             
, ProvisionCurrency    
, ProductNumber            
, PortfolioCode   
, BeneficiaryPortfolioCode 
, GuaranteeStatus      
, GLAccount                
, IsCancellable       
, IsDefaulted
, DefaultDate      
, AccountNumber
, RiskStageCode
, RiskStageName
, ContractNumber
, AdjustedRiskStageCode
, AdjustedRiskStageName
, OpenAmount
, UncommittedFlag
, ActualExpiryDate
, OriginalSource
, LBCreditNumber
, PaidAmountDueDebtGLAccount
, 'N/D' as MigratedGuaranteeCode
, '9999-12-31' as MigrationDate
, '99991231' as MigrationDateID
, 'N/D' as MigratedEntity
from DWSkey.DimGuarantee_Old d
where d.GuaranteeKey not in ( 0, 1 );

commit;

alter table DWSKey.DimGuarantee alter GuaranteeID default autoincrement;
drop table DWSkey.DimGuarantee_Old;

message 'DWSKey structure recreated and data is restored.' type info to client;

read 'C:\Users\Administrator\Desktop\patch01\VWKey.DimGuarantee.ddl';

message 'Create new DWConform structure and restore data ...' type info to client;

drop table if exists DWConform.DimGuarantee;
read 'C:\Users\Administrator\Desktop\patch01\DWConform.DimGuarantee.ddl';


drop table if exists DW.DimGuarantee;
read 'C:\Users\Administrator\Desktop\patch01\DW.DimGuarantee.ddl';

insert into DW.DimGuarantee(                                                                                                                                    
    ETLProcessID                
   ,ETLProcessRunID             
   ,ETLProcessDateID            
   ,GuaranteeID                 
   ,GuaranteeKey                
   ,StartDateID                 
   ,EndDateID                   
   ,Entity                      
   ,SourceSystemID              
   ,GuaranteeCode               
   ,AgreementNumber             
   ,GuaranteeStartDateID        
   ,GuaranteeStartDate          
   ,GuaranteeMaturityDateID     
   ,GuaranteeMaturityDate       
   ,CurrencyKey                 
   ,ProvisionCurrencyKey        
   ,ProductKey                  
   ,CustomerPortfolioKey        
   ,BeneficiaryPortfolioKey     
   ,GuaranteeStatusID           
   ,GLKey                       
   ,IsCancellableID             
   ,IsCancellableDispN          
   ,IsDefaultedID               
   ,IsDefaultedDispN            
   ,DefaultDateID               
   ,DepositKey                  
   ,RiskStageID                 
   ,RiskStageCode               
   ,RiskStageName               
   ,ContractNumber              
   ,AdjustedRiskStageID         
   ,AdjustedRiskStageCode       
   ,AdjustedRiskStageName       
   ,UncommittedFlag	           
   ,ActualExpiryDateID          
   ,ActualExpiryDate            
   ,OriginalSource              
   ,LBCreditNumber              
   ,OpenAmount	               
   ,PaidAmountDueDebtGLKey      
   ,MigratedGuaranteeCode       
   ,MigrationDate               
   ,MigrationDateID             
   ,MigratedEntity   
)                                                                                                                                                               
select                                                                                                                                                          
    ETLProcessID                
   ,ETLProcessRunID             
   ,ETLProcessDateID            
   ,GuaranteeID                 
   ,GuaranteeKey                
   ,StartDateID                 
   ,EndDateID                   
   ,Entity                      
   ,SourceSystemID              
   ,GuaranteeCode               
   ,AgreementNumber             
   ,GuaranteeStartDateID        
   ,GuaranteeStartDate          
   ,GuaranteeMaturityDateID     
   ,GuaranteeMaturityDate       
   ,CurrencyKey                 
   ,ProvisionCurrencyKey        
   ,ProductKey                  
   ,CustomerPortfolioKey        
   ,BeneficiaryPortfolioKey     
   ,GuaranteeStatusID           
   ,GLKey                       
   ,IsCancellableID             
   ,IsCancellableDispN          
   ,IsDefaultedID               
   ,IsDefaultedDispN            
   ,DefaultDateID               
   ,DepositKey                  
   ,RiskStageID                 
   ,RiskStageCode               
   ,RiskStageName               
   ,ContractNumber              
   ,AdjustedRiskStageID         
   ,AdjustedRiskStageCode       
   ,AdjustedRiskStageName       
   ,UncommittedFlag	           
   ,ActualExpiryDateID          
   ,ActualExpiryDate            
   ,OriginalSource              
   ,LBCreditNumber              
   ,OpenAmount	               
   ,PaidAmountDueDebtGLKey      
   ,'N/D' as MigratedGuaranteeCode       
   ,'9999-12-31' as MigrationDate               
   ,99991231 as MigrationDateID             
   ,'N/D' as MigratedEntity   
from DW.DimGuarantee_Old
where GuaranteeID not in (0,1);

read 'C:\Users\Administrator\Desktop\patch01\DimGuarantee.DW.indexes.ddl';
commit;
drop table DW.DimGuarantee_Old;

message 'DW structure recreated and data is restored.' type info to client;